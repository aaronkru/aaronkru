<!DOCTYPE html>
<head>
  <title>County Demochartsics</title>
  <style type="text/css">
    body {
        font-size: 100%;
        font-family: "Helvetica Neue", Helvetica, Arial, sans-serif;
        width: 960px;
    }
  </style>
  <meta charset="utf-8">
</head>

<body>
  
  <div id="donut-charts"></div>
  <div id="drop" align="center"></div>
  
  <script src="http://code.jquery.com/jquery-1.10.1.min.js"></script>
  <script src="http://d3js.org/d3.v4.min.js"></script>
  
  <script>
  $(function() {
    /*//set the dimensions of the canvas & charts
    var svg = d3.select("svg"),
        margin = {top: 20, bottom: 30, left: 40, right: 20},
        width = +svg.attr("width") - margin.left - margin.right,
        height = +svg.attr("height") - margin.top - margin.bottom;
    
    //add the svg canvas
    var charts = svg.append("g").attr("transform", "translate(" + margin.left + "," + margin.top + ")");*/
    
    //enter data, make legend, signal transitions
    d3.csv("data.csv", formatData, function(error, data) {
      if (error) throw error;
      
      var chart_m,
          chart_r;
            
      var counties = data.columns.slice(2).map(function(id) {
        return {
          id: id,
          values: data.map(function(d) {
            return {ethn: d.Ethnicity, perc: d[id]};
          })
        };
      });
      
      var countyAndState = [counties[1], counties[0]];
      console.log("DEBUG_1")
      console.log(countyAndState)
      console.log(counties)
      
      var donuts = new DonutCharts();
      donuts.create(countyAndState, "Adair");
      
      var selector = d3.select("#drop")
          .append("select")
          .attr("id", "dropdown")
          .on("change", function(d) {
            
            selection = this.options[this.selectedIndex].value;
            countyAndState[1] = countyAndState[countyAndState.findIndex(x => x.id == selection)]
            
            donuts.update(countyAndState, selection);
          });
      
      //Input all the drop-down options
      selector.selectAll("option")
          .data(data.columns.slice(3))
          .enter().append("option")
          .attr("value", function(d){
            return d;
          })
          .text(function(d){
            return d;
          });
      
    });
  });
           
    //Controls everything about the pie charts:
    function DonutCharts() {
      
      var color = d3.scaleOrdinal(d3.schemeCategory20);
      
      var charts = d3.select('#donut-charts');
      
      var createCenter = function(pie) {
        //Animates the slices of pie
        var eventObj = {
          'mouseover': function(d, i) {
            console.log("affirm")
            d3.select(this)
              .transition()
              .attr("r", chart_r * 0.65);
          },
          'mouseout': function(d, i) {
            d3.select(this)
              .transition()
              .duration(500)
              .ease(d3.easeBounce)
              .attr("r", chart_r * 0.6);
          },
          'click': function(d, i) {
            var paths = charts.selectAll(".clicked");
            pathAnim(paths, 0);
            paths.classed('clicked', 'false');
            resetAllCenterText();
          }
        }
        
        //This will be the circle displaying total data:
        var donuts = d3.selectAll('.donut');
        
        donuts.append("circle")
          .attr("r", chart_r * .6)
          .style("fill", "#E7E7E7")
          .on('mouseover', eventObj['mouseover'])
          .on('mouseout', eventObj['mouseout'])
          .on('click', eventObj['click']);
        
        donuts.append("text")
          .attr("class", "center-txt county")
          .attr("y", chart_r * -0.16)
          .attr("text-anchor", "middle")
          .style("font-weight", "bold")
          .text(function(d,i) {
            return d.id;
        });
        
        donuts.append("text")
          .attr("class", "center-txt ethnicity")
          .attr("text-anchor", "middle");
        
        donuts.append("text")
          .attr("class", "center-txt percentage")
          .attr("y", chart_r * 0.16)
          .attr("text-anchor", "middle")
          .style('fill', '#A2A2A2');
      }
      
      var setCenterText = function(thisDonut) {
        //Controls what text displays inside the pie charts
        var sum = d3.sum(thisDonut.selectAll(".clicked").data(), function(d) {
          return d.data.perc;
        });
        
        thisDonut.select(".percentage")
          .text(function(d) {
            return (sum) ? (sum).toFixed(2) + "%" : '';
        });
      }
      
      var resetAllCenterText = function() {
        charts.selectAll('.percentage')
          .text('');
      }
      
      var pathAnim = function(path, dir) {
        switch(dir) {
            
          case 0:
            path.transition()
              .duration(500)
              .ease(d3.easeBounce)
              .attr('d', d3.arc()
                   .innerRadius(chart_r * 0.7)
                   .outerRadius(chart_r)
              );
            break;
            
          case 1:
            path.transition()
              .attr('d', d3.arc()
                   .innerRadius(chart_r * 0.7)
                   .outerRadius(chart_r * 1.08)
              );
            break;
        }
      }
      
      var updateDonut = function(section) {
        
       /* var title = d3.select(".county");
        title.text(function(d) {
          console.log("TITLE")
          return section;
        }); */
        
        var eventObj = {
          
          'mouseover': function(d, i, j) {
            pathAnim(d3.select(this), 1);
            console.log(j)
            var thisDonut = charts.select(".county0");
            thisDonut.select(".ethnicity").text(function(donut_d) {
              return d.data.ethn;});
            thisDonut.select(".percentage").text(function(donut_d) {
              return (d.data.perc).toFixed(2) + '%';});
          },
          
          'mouseout': function(d, i, j) {
            var thisPath = d3.select(this);
            if (!thisPath.classed('clicked')) {
              pathAnim(thisPath, 0);
            }
            
            var thisDonut = charts.select('.county0');
            thisDonut.select('.ethnicity').text('');
            setCenterText(thisDonut);
          },
          
          'click': function(d, i, j) {
            var thisDonut = charts.select(".county0");
            if (0 == thisDonut.selectAll('.clicked').length) {
              thisDonut.select("circle").on("click")();
            }
            
            var thisPath = d3.select(this);
            var clicked = thisPath.classed("clicked");
            
            pathAnim(thisPath, ~~(!clicked));
            thisPath.classed("clicked", !clicked);
            setCenterText(thisDonut);
          }
        };
                
        var pie = d3.pie()
            .sort(null)
            .value(function(d) {
              return d.perc;});
        
        var arc = d3.arc()
            .innerRadius(chart_r * 0.7)
            .outerRadius(function() {
              return (d3.select(this).classed("clicked")) ? chart_r * 1.08 : chart_r;
            });
        
        var paths = charts.selectAll(".donut")
            .selectAll("path")
            .data(function(d, i) {
              return pie(d.values);});
                
        paths.transition()
            .duration(1000)
            .attr("d", arc);
        
        paths.enter().append("path")
            .attr("d", arc)
            .attr("class", "slice")
            .style("fill", function(d, i) {return color(i);})
            .style("stroke", "#FFFFFF")
            .on('mouseover', eventObj['mouseover'])
            .on('mouseout', eventObj['mouseout'])
            .on('click', eventObj['click']);
        paths.exit().remove();
        resetAllCenterText();
      }
      
      this.create = function(data, section) {
        //var prelim = document.getElementById('#donut-charts');
        //var charts = d3.select();
        var $charts = $('#donut-charts');    
        
        chart_m = $charts.innerWidth() / data.length / 2 * 0.14;
            
        chart_r = $charts.innerWidth() / data.length / 2 * 0.85;
            
        var m_r = chart_m + chart_r;
        
        var donut = charts.selectAll(".donut")
            .data(data)
          .enter().append("svg")
            .attr('width', (m_r) * 2)
            .attr("height", (m_r) * 2)
          .append("g")
            .attr("class", function(d, i) {return "donut county" + i;})
            .attr('transform', 'translate(' + m_r + ',' + m_r + ')');
        
        createCenter()
        updateDonut()
      }
      
      this.update = function(data, section) {
        var donut = charts.select('.donut')
            .data(data);
        updateDonut(section);
      } 
    }
    
    //Helper function for the d3.csv method:
    function formatData(d, i, columns) {
      for (var i = 1, n = columns.length; i < n; ++i)
        d[columns[i]] = +d[columns[i]];
      return d;
    }
    
  </script>
</body>