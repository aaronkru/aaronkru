
<html>
<head>
	<script src="http://d3js.org/d3.v3.min.js" charset="utf-8"></script>
	<link rel="stylesheet" href="style.css">
</head>

<body>

	<div id="everything">
		<h1>Where Do Most People Work?</h1>
		<h2>Top 5 Economic Sectors by Employment, by County in Oklahoma</h2>	
		<div id="chart"></div>
		<h2>More data at <a href="http://www.okpolicy.com/">okpolicy.com</a></h2>
	</div>

<script>
  
    var setup = function(targetID){
        //Set size of svg element and chart
        var margin = {top: 0, right: 0, bottom: 0, left: 0},
            width = 600 - margin.left - margin.right,
            height = 400 - margin.top - margin.bottom,
            categoryIndent = 4*15 + 5,
            defaultBarWidth = 2000;

        //Set up scales
        var y = d3.scale.linear()
          .domain([0,defaultBarWidth])
          .range([0,height]);
        var x = d3.scale.ordinal()
          .rangeRoundBands([0, width], 0.1, 0);

        //Create SVG element
        d3.select(targetID).selectAll("svg").remove()
        var svg = d3.select(targetID).append("svg")
            .attr("width", width + margin.left + margin.right)
            .attr("height", height + margin.top + margin.bottom)
          .append("g")
            .attr("transform", "translate(" + margin.left + "," + margin.top + ")");

        //Package and export settings
        var settings = {
          margin:margin, width:width, height:height, categoryIndent:categoryIndent,
          svg:svg, x:x, y:y
        }
        return settings;
    }
    
    var redrawChart = function(targetID, newdata) {
        
        //Import or create settings somehow
        var margin=settings.margin, width=settings.width, height=settings.height, categoryIndent=settings.categoryIndent, 
	        svg=settings.svg, x=settings.x, y=settings.y;
        
        //Reset domains
        x.domain(newdata.sort(function(a,b){
          return b.values[0] - a.values[0];
        })
          .map(function(d) { return d.sector; }));
      
        var barmax = d3.max(newdata, function(e) {
          return Math.max(e.values[0], e.values[1]);
        });
        y.domain([0, barmax + 8]);
      
      /////////
      //ENTER//
      /////////
      
      //Bind new data to chart columns (sectors), which will then be divided into two bars (state & county)
      
      console.log(newdata);
      
      //Create sector column and move to past the right edge of the chart
      var sectorCol = svg.selectAll("g.sectorCol")
        .data(newdata, function(d) { return d.sector; });
      var newCol = sectorCol
        .enter()
        .append("g")
        .attr("class", "sectorCol")
        .attr("transform", "translate(" + width + margin.left + margin.right + ", 0)");
      
      //Make a county bar and a state bar for each sector
      newCol.selectAll('.bar')
        .data(newdata.forEach(function(d) { console.log(d.values); return d.values;}))
        .enter()
        .append("rect")
        .attr("class", "bar")
        /*.attr("transform", function(d,i) {
            if (i == 1)
              var offset = x.bandwidth() / 2;  //Probably should be something like +5, -5
            else
              var offset = -1 * x.bandwidth() / 2;
            return "translate(" + offset + ",0)" })*/
        .attr("x", function(d) {console.log(d); return x(d.sector); })
        .attr("y", function(d, i) { return y(d.values[i]); })
        .attr("opacity", 0)
        .attr("height", function(d, i) { return height - y(d.values[i]); })
        .attr("width", x.rangeBand() / 2)
        /*.on('mouseover', function(d) {
          d3.select(this).attr("fill", d3.rgb(z(d.Type)).brighter(0.5));
          tip.show(d);
        })
        .on('mouseout', function(d) {
          d3.select(this).attr("fill", d3.rgb(z(d.Type)).darker(0.1));
          tip.hide(d);
        });*/
      
      newCol.append("text")
        .attr("class", "category")
        .attr("text-overflow", "ellipsis")
        .attr("x", x.rangeBand() / 2)
        .attr("y", height + 10)
        .attr("opacity", 0)
        .attr("dy", ".35em")
        .attr("dx", "0.5em")
        .text(function(d) { return d.sector; });
      
      //////////
      //UPDATE//
      //////////
      
      //Update bar heights
      sectorCol.select(".bar").transition()
        .duration(300)
        .attr("height", function(d, i) { return height - y(d.values[i]); })
        .attr("opacity", 1);
      
      sectorCol.select(".category").transition()
        .duration(300)
        .attr("opacity", 1)
      
      ////////
      //EXIT//
      ////////
      
      sectorCol.exit().transition()
        .style("opacity", 0)
        .attr("transform", "translate(" + width + margin.left + margin.right + ", 0)")
        .remove();
      
      ///////////////////
      //REORDER SECTORS//
      ///////////////////
      
      var delay = function(d, i) { return 200 * i * 30; };
      
      sectorCol.transition()
        .delay(delay)
        .duration(900)
        .attr("transform", function(d) { return "translate(" + x(d.sector) + ", 0)"; });
      
  };
      
  var getData = function(selection, settings, callback) {
      d3.csv("employmentSectors.csv", function(error, data) {
        if (error) throw error;

        var newData = [];
        data.forEach(function(value, idx, arr) {
          var sector = String(data[idx].Sector),
              countyVal = +value[selection],
              stateVal = +value['State'],
              group = {};

          group["sector"] = sector;
          group["values"] = [countyVal, stateVal];
          newData.push(group);
        });

        newdata = formatData(newData);

        callback(settings, newData);
      });
  }
  
  var formatData = function(data) {
      return data.sort(function (a, b) {
        return b.values[0] - a.values[0];
      })
      .slice(0, 5);
  }
  
  var redraw = function(selection, settings) {
      getData(selection, settings, redrawChart)
  }
  
  var settings = setup('#chart'),
      selection = 'Adair County';
  redraw(selection, settings);
    
  var selector = window.parent.document.getElementById('dropdown');
  selector = d3.select(selector)
    .on("change.tes", function(d){

      //update data
        selection = this.options[this.selectedIndex].value;

        redraw(selection, settings)

      //Update the legend
        /*legendText.data(["State", selection]);
        legendText.transition()
            .text(function(d) {return d;})*/
    });
</script>